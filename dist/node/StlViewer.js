var e=require("three"),t=require("three/examples/jsm/controls/OrbitControls"),s=require("three/examples/jsm/controls/TrackballControls"),o=require("three/examples/jsm/renderers/Projector"),a=require("three/examples/jsm/deprecated/Geometry"),l="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};e.OrbitControls=t.OrbitControls,e.TrackballControls=s.TrackballControls,e.Projector=o.Projector,e.Face3=a.Face3,e.Geometry=a.Geometry;var r;r=new URL("worker.109b65d1.js","file:"+__filename).toString();class n{get_opt(e,t){return this.options?!1!==this.options[e]&&(this.options[e]?this.options[e]:t):t}set_on_model_mousedown(e){this.onmousedown_callback=e,this.onmousedown_callback&&(this.parent_element.addEventListener("mousedown",this.onmousedown),this.parent_element.addEventListener("dblclick",this.onmousedown),this.parent_element.addEventListener("touchstart",this.onmousedown))}set_drag_and_drop(e){e?(this.parent_element.addEventListener("dragover",this.handleDragOver),this.parent_element.addEventListener("drop",this.handleFileDrop)):(this.parent_element.removeEventListener("dragover",this.handleDragOver),this.parent_element.removeEventListener("drop",this.handleFileDrop))}set_options(){this.canvas_width=this.get_opt("width",this.canvas_width),this.canvas_height=this.get_opt("height",this.canvas_height),this.bg_color=this.get_opt("bg_color",this.bg_color),this.models_to_add=this.get_opt("models",this.models_to_add),this.model_loaded_callback=this.get_opt("model_loaded_callback",this.model_loaded_callback),this.all_loaded_callback=this.get_opt("all_loaded_callback",this.all_loaded_callback),this.load_error_callback=this.get_opt("load_error_callback",this.load_error_callback),this.loading_progress_callback=this.get_opt("loading_progress_callback",this.loading_progress_callback),this.onmousedown_callback=this.get_opt("on_model_mousedown",this.onmousedown_callback),this.onmousedown_callback||(this.onmousedown_callback=this.get_opt("on_model_mouseclick",null)),this.send_no_model_click_event=this.get_opt("send_no_model_click_event",this.send_no_model_click_event),this.zoom=this.get_opt("zoom",this.zoom),this.camerax=this.get_opt("camerax",this.camerax),this.cameray=this.get_opt("cameray",this.cameray),this.auto_rotate=this.get_opt("auto_rotate",this.auto_rotate),this.mouse_zoom=this.get_opt("mouse_zoom",this.mouse_zoom),this.ready_callback=this.get_opt("ready_callback",null),this.jszip_path=this.get_opt("jszip_path",null),this.jszip_utils_path=this.get_opt("jszip_utils_path",null),this.auto_resize=this.get_opt("auto_resize",this.auto_resize),this.on_model_drop=this.get_opt("on_model_drop",this.on_model_drop),this.center_models=this.get_opt("center_models",this.center_models),this.controls_type=this.get_opt("controls",this.controls_type),this.grid=this.get_opt("grid",!!this.grid),this.zoom>=0?this.cameraz=this.zoom:this.cameraz=this.get_opt("cameraz",this.cameraz),this.camera_state=this.get_opt("camera_state",this.camera_state),this.allow_drag_and_drop&&this.set_drag_and_drop(!0)}load_model(e){return this.max_model_id=Math.max(this.max_model_id,e.id),e.filename||e.local_file?this.load_from_stl_file(e,!1):e.mesh?this.add_from_existing_mesh(e):void this.models_count--}add_from_existing_mesh(e){this.set_model_custom_props(e),e.mesh.model_id=e.id,this.set_geo_minmax(e),this.recalc_dims(e),e.color="#"+e.mesh.material.color.getHexString(),this.scene.add(e.mesh),this.model_loaded(e.id),this.check_loading_status(e,0,0),e.mesh.geometry.boundingBox||e.mesh.geometry.computeBoundingBox(),this.model_loaded_callback&&this.model_loaded_callback(e.id)}load_from_stl_file(t){let i=new Worker(new URL(r),{type:"module"}),s=this;i.onmessage=function(o){switch(o.data.msg_type){case s.MSGFROMWORKER_STL_LOADED:t.colors=o.data.colors;let a=s.vf_to_geo(o.data.vertices,o.data.faces,!!o.data.colors&&o.data.colors,t.color);if(a){let i=new e.MeshLambertMaterial({color:9474192,wireframe:!1,vertexColors:t.color?e.NoColors:e.FaceColors});s.is_ie||(i.side=e.DoubleSide),t.display||(t.display="flat"),s.set_material_display(t.display,i,a),t.mesh=new e.Mesh(a,i),s.set_model_custom_props(t),s.set_geo_minmax(t),t.mesh.model_id=t.id,s.recalc_dims(t),s.scene.add(t.mesh),s.model_loaded(t.id),s.model_loaded_callback&&s.model_loaded_callback(t.id)}else console.log("Error VF data ");i.terminate(),i=void 0,s.pre_loaded_ab_files&&t.filename&&s.pre_loaded_ab_files[t.filename]&&delete s.pre_loaded_ab_files[t.filename];break;case s.MSGFROMWORKER_LOAD_IN_PROGRESS:s.check_loading_status(t,o.data.loaded,o.data.total);break;case s.MSG2WORKER_ERROR:s.models_count--,s.model_error("ERROR: "+o.data.data,s.load_error_callback),s.pre_loaded_ab_files&&t.filename&&s.pre_loaded_ab_files[t.filename]&&delete s.pre_loaded_ab_files[t.filename]}},t.bytes_loaded=0,t.bytes_total=0;let o=null;this.pre_loaded_ab_files&&t.filename&&this.pre_loaded_ab_files[t.filename]&&(o=this.pre_loaded_ab_files[t.filename]),i.postMessage({msg_type:this.MSG2WORKER_DATA,data:t,load_from_blob_or_ab:o,get_progress:null!=this.loading_progress_callback,jszip_path:this.jszip_path}),i.postMessage({msg_type:this.MSG2WORKER_LOAD})}model_loaded(e){this.loaded_models_arr[e]=1,Object.keys(this.loaded_models_arr).length>=this.models_count&&(this.camera_state?this.camera_state=null:this.set_zoom(),this.set_light(),this.set_grid(!!this.grid),this.load_session++,this.all_loaded_callback&&this.all_loaded_callback())}set_grid(t,i,s){if(this.grid&&this.scene.remove(this.grid),this.grid=null,t){if(i||(i=2.5*Math.max(Math.abs(this.maxx),Math.abs(this.minx))),i<=0){let e=isNaN(window.innerHeight)?window.clientHeight:window.innerHeight,t=isNaN(window.innerWidth)?window.clientWidth:window.innerWidth;i=.8*Math.min(e,t)}s||(s=10),this.grid=new e.GridHelper(i,s),this.scene.add(this.grid)}}remove_model(e){if(void 0===this.models_ref[e])return this.model_error("remove_model - id not found: "+e);let t=this.models[this.models_ref[e]];t&&(this.set_or_update_geo_edges(t,!1),delete this.models[this.models_ref[e]],delete this.models_ref[e],delete this.loaded_models_arr[e],this.max_model_id=-1,Object.keys(this.models_ref).forEach((function(e){this.max_model_id=Math.max(this.models[this.models_ref[e]].id,this.max_model_id)})),this.models_count=Object.keys(this.models).length,this.scene.remove(t.mesh))}set_zoom(e,t){if(e&&(this.zoom=e),this.zoom_done&&!t)return;this.zoom_done=!0;let i=this.zoom;this.zoom<0&&(i=this.calc_z_for_auto_zoom()),this.camera.position.set(this.camera.position.x,this.camera.position.y,i);const s=this.minz,o=s<0?-s+i:i-s;this.camera.far=Math.max(3e3*o,this.camera.far),this.camera.updateProjectionMatrix()}calc_z_for_auto_zoom(t){t=t||1.01;const i=new e.Box3(new e.Vector3(this.minx,this.miny,this.minz),new e.Vector3(this.maxx,this.maxy,this.maxz));let s=new e.Vector3;i.getSize(s);const o=this.camera.fov*(Math.PI/180),a=2*Math.atan(Math.tan(o/2)*this.camera.aspect);let l=s.z/2+Math.abs(s.x/2/Math.tan(a/2)),r=s.z/2+Math.abs(s.y/2/Math.tan(o/2)),n=Math.max(l,r);return n*=t,n}get_camera_state(){if(!this.camera)return null;let t=new e.Vector3,i=new e.Vector3,s=new e.Vector3(0,0,0);return t.copy(this.camera.position),i.copy(this.camera.up),this.controls&&s.copy(this.controls.target),{position:t,up:i,target:s}}set_camera_state(e){if(!this.camera)return null;if(!e)return this.model_error("set_camera_state - no state vector");if(void 0!==e.position){if(void 0===e.position.x)return this.model_error("set_camera_state - invalid position x");if(void 0===e.position.y)return this.model_error("set_camera_state - invalid position y");if(void 0===e.position.z)return this.model_error("set_camera_state - invalid position z");this.camera.position.set(e.position.x,e.position.y,e.position.z)}if(void 0!==e.up){if(void 0===e.up.x)return this.model_error("set_camera_state invalid up x");if(void 0===e.up.y)return this.model_error("set_camera_state invalid up y");if(void 0===e.up.z)return this.model_error("set_camera_state invalid up z");this.camera.up.set(e.up.x,e.up.y,e.up.z)}if(this.controls&&void 0!==e.target){if(void 0===e.target.x)return this.model_error("set_camera_state - invalid target x");if(void 0===e.target.y)return this.model_error("set_camera_state - invalid target y");if(void 0===e.target.z)return this.model_error("set_camera_state - invalid target z");this.controls.target.set(e.target.x,e.target.y,e.target.z)}}set_center_models(e){this.center_models=e}set_light(){this.directionalLight.position.x=2*this.maxy,this.directionalLight.position.y=2*this.miny,this.directionalLight.position.z=2*this.maxz,this.pointLight.position.x=(this.miny+this.maxy)/2,this.pointLight.position.y=(this.miny+this.maxy)/2,this.pointLight.position.z=2*this.maxz}stop_auto_zoom(){this.zoom=this.camera.position.z,this.zoom_done=!0}set_camera(e,t,i){t&&(this.zoom=t),this.camera.position.set(this.is_empty(e)?this.camera.position.x:e,this.is_empty(t)?this.camera.position.y:t,this.is_empty(i)?this.camera.position.z:i)}set_auto_zoom(){this.set_zoom(-1)}check_loading_status(e,t,i){e&&(this.load_status[e.id]={loaded:t,total:i,load_session:this.load_session}),this.loading_progress_callback&&Object.keys(this.load_status).length==this.models_count&&this.loading_progress_callback(this.load_status,this.load_session)}set_edges(e,t){if(void 0===this.models_ref[e])return this.model_error("set_edges - id not found: "+e);let i=this.models[this.models_ref[e]];i&&this.set_or_update_geo_edges(i,t)}set_or_update_geo_edges(t,i,s){if((!i||s)&&(t.edges&&this.scene.remove(t.edges),t.edges=null,!i))return;let o=!1;if(s=s||!1,!t.edges||s){let i=t.mesh.geometry;t.edges=new e.LineSegments(new e.EdgesGeometry(i),this.edges_material),o=!0}(t.x||t.y||t.z)&&t.edges.position.set(t.x?t.x:0,t.y?t.y:0,t.z?t.z:0),t.edges.rotation.setFromRotationMatrix(t.mesh.matrix),o&&this.scene.add(t.edges)}set_model_custom_props(e){e.units=e.units?e.units:"mm",this.set_model_units(e.id,e.units,!0),e.x=e.x?e.x:0,e.y=e.y?e.y:0,e.z=e.z?e.z:0,e.mesh.position.set(e.x,e.y,e.z),e.color?this.update_mesh_color(e.mesh,e.color,!1):e.colors&&this.update_mesh_color(e.mesh,"#FFFFFF",!0),e.rotationx=e.rotationx?e.rotationx:0,e.rotationy=e.rotationy?e.rotationy:0,e.rotationz=e.rotationz?e.rotationz:0,(e.rotationx||e.rotationy||e.rotationz)&&this.set_rotation(e.id,e.rotationx,e.rotationy,e.rotationz);let t=void 0!==e.scale?e.scale:1,i=void 0!==e.scalex?e.scalex:t,s=void 0!==e.scaley?e.scaley:t,o=void 0!==e.scalez?e.scalez:t;e.scalex=i,e.scaley=s,e.scalez=o,1==i&&1==s&&1==o||this.scale_geo(e,i,s,o),e.view_edges&&this.set_or_update_geo_edges(e,!0),void 0!==e.opacity&&this.set_material_opacity(e.mesh.material,e.opacity),e.animation&&(this.animation[e.id]=1)}set_scale(e,t,i,s,o){if(void 0===this.models_ref[e])return this.model_error("set_scale - id not found: "+e);let a=this.models[this.models_ref[e]];if(!a)return;if(!a.mesh)return;if(!a.mesh.geometry)return;let l=Math.max(a.scalex,.01),r=Math.max(a.scaley,.01),n=Math.max(a.scalez,.01);t&&(a.scalex=Math.max(t,.01)),a.scaley=Math.max(i||t,.01),a.scalez=Math.max(s||t,.01),this.scale_geo(a,a.scalex/l,a.scaley/r,a.scalez/n),a.edges&&this.set_or_update_geo_edges(a,!0,!0),o&&(a.scalex=l,a.scaley=r,a.scalez=n)}scale_geo(e,t,i,s){e.mesh.geometry.scale(t,i,s)}recalc_dims(e){let t=e.mesh.geometry;this.maxx=this.maxx?Math.max(this.maxx,t.maxx+e.x):t.maxx+e.x,this.maxy=this.maxy?Math.max(this.maxy,t.maxy+e.y):t.maxy+e.y,this.maxz=this.maxz?Math.max(this.maxz,t.maxz+e.z):t.maxz+e.z,this.minx=this.maxx?Math.min(this.minx,t.minx+e.x):t.minx+e.x,this.miny=this.maxy?Math.min(this.miny,t.miny+e.y):t.miny+e.y,this.minz=this.maxz?Math.min(this.minz,t.minz+e.z):t.minz+e.z}update_mesh_color(t,i,s){null!=t&&("transparent"!=i?(t.traverse((function(e){e.visible=!0})),t.material.vertexColors=s?e.FaceColors:e.NoColors,s&&!i&&(i="#FFFFFF"),i&&t.material.color.set(parseInt(i.substr(1),16)),t.material.needsUpdate=!0):t.traverse((function(e){e.visible=!1})))}set_color(e,t){if(void 0===this.models_ref[e])return this.model_error("set_color - id not found: "+e);let i=this.models[this.models_ref[e]];i&&i.mesh&&(t.length<6||("#"!=t.charAt(0)&&(t="#"+t),i.color=t,this.update_mesh_color(i.mesh,t,!t&&i.colors)))}error_in_model(e){if(!e.id&&0!=e.id&&-1!=e.id)return this.model_error("missing id");if(!Number.isInteger(e.id))return this.model_error("invalid id");if(e.id<-1)return this.model_error("id must be positive");if(!e.filename&&!e.mesh&&!e.local_file){if(!e.name)return this.model_error("missing filename or mesh");e.filename=e.name}return this.models_ref[e.id]?this.model_error("such model ID already exists: "+e.id):null}model_error(e,t){return console.log(e),this.status=-1,this.error=e,t&&t(e),e}set_bg_color(e){"transparent"==e?this.renderer.setClearColor(0,0):this.renderer.setClearColor(e,1),this.bg_color=e}set_display(e,t){if(void 0===this.models_ref[e])return this.model_error("set_display - id not found: "+e);let i=this.models[this.models_ref[e]];i&&(this.set_material_display(t,i.mesh.material,i.mesh.geometry),i.display=t,i.mesh&&(i.mesh.normalsNeedUpdate=!0))}set_opacity(e,t){if(void 0===this.models_ref[e])return this.model_error("set_display - id not found: "+e);let i=this.models[this.models_ref[e]];i&&(i.opacity=t,this.set_material_opacity(i.mesh.material,t))}set_material_opacity(e,t){e&&(t<1?(e.opacity=t,e.transparent=!0):(e.opacity=1,e.transparent=!1))}onmousedown(e){e.stopPropagation(),e.preventDefault();let t=e.which;switch(e.type){case"touchstart":t=20;let i=e.touches[0]||e.changedTouches[0];this.mouse.x=(i.pageX-this.parent_element.offsetLeft)/this.parent_element.clientWidth*2-1,this.mouse.y=-(i.pageY-this.parent_element.offsetTop)/this.parent_element.clientHeight*2+1;break;case"dblclick":t=11;default:this.mouse.x=(e.clientX-this.parent_element.offsetLeft)/this.parent_element.clientWidth*2-1,this.mouse.y=-(e.clientY-this.parent_element.offsetTop)/this.parent_element.clientHeight*2+1}this.raycaster.setFromCamera(this.mouse,this.camera);let i=this.raycaster.intersectObjects(this.scene.children);if(i.length>0){if(void 0===i[0].object.model_id)return;this.onmousedown_callback&&this.onmousedown_callback(i[0].object.model_id,e,i[0].distance,t)}else this.send_no_model_click_event&&this.onmousedown_callback(null,e,0,t)}is_empty(e){return!e&&0!==e}set_model_units(e,t,i){if(void 0===this.models_ref[e])return this.model_error("set_model_units - id not found: "+e);let s=this.models[this.models_ref[e]];if(!s)return;if(!s.mesh)return;let o=1;switch(t){case"mm":i&&"inch"==s.units&&(o=1/25.4),s.units="mm";break;case"inch":i&&"mm"==s.units&&(o=25.4),s.units="inch";break;default:return this.model_error("set_model_units - invalid unit "+t)}1!=o&&this.set_scale(s.id,s.scalex*o,s.scaley*o,s.scalez*o,!0)}set_position(e,t,i,s){if(void 0===this.models_ref[e])return this.model_error("set_position - id not found: "+e);let o=this.models[this.models_ref[e]];o&&o.mesh&&(o.x=this.is_empty(t)?o.x:t,o.y=this.is_empty(i)?o.y:i,o.z=this.is_empty(s)?o.z:s,o.mesh.position.set(o.x,o.y,o.z),o.edges&&this.set_or_update_geo_edges(o,!0,!0))}set_material_display(e,t,i){switch(e.toLowerCase()){case"wireframe":t.wireframe=!0;break;case"smooth":t.wireframe=!1,t.flatShading=!1,i&&(i.mergeVertices(),i.computeVertexNormals());break;case"flat":t.wireframe=!1,t.flatShading=!0,i&&i.computeFlatVertexNormals()}}set_rotation(e,t,i,s,o){if(void 0===this.models_ref[e])return this.model_error("rotate - id not found: "+e);let a=this.models[this.models_ref[e]];if(!a)return;let l=o?1:0;void 0!==t&&(a.rotationx=t+a.mesh.rotation.x*l,a.mesh.rotation.x=a.rotationx),void 0!==i&&(a.rotationy=i+a.mesh.rotation.y*l,a.mesh.rotation.y=a.rotationy),void 0!==s&&(a.rotationz=s+a.mesh.rotation.z*l,a.mesh.rotation.z=a.rotationz),a.mesh.updateMatrixWorld(),a.edges&&this.set_or_update_geo_edges(a,!0)}rotate(e,t,i,s){this.set_rotation(e,t,i,s,!0)}basename(e){return e.split(/[\\/]/).pop()}get_model_filename(e,t,i,s){let o=null;return e.orig_url&&!s?o=decodeURIComponent(e.orig_url):e.orig_filename?o=e.orig_filename:e.temp_filename?o=e.temp_filename:e.local_file?e.local_file.name&&(o=e.local_file.name):e.filename&&(e.filename instanceof File&&(o=File.name),o=e.filename),!o&&t?"model_"+e.id+".stl":o?(i&&(o=this.basename(o)),o):null}add_model(e,t){if(Array.isArray(e))return this.add_models(e);if(!this.ready)return this.models_to_add.push(e),this.model_error("THREE JS files are not ready");let i=this.get_model_filename(e);if(i)switch(i.split(".").pop()){case"vsj":return this.load_vsj(e.local_file?e.local_file:i);case"vsb":return this.load_vsb(e.local_file?e.local_file:i)}void 0===e.id&&(e.id=-1);let s=this.error_in_model(e);if(s)return s;-1==e.id&&(e.id=++this.max_model_id),this.models.push(e);let o=this.models.indexOf(e);return t||void 0===this.models_ref[e.id]&&this.models_count++,this.models_ref[e.id]=o,this.load_model(e),this.status}add_models(e){if(!Array.isArray(e))return this.add_model(e);this.status=0;let t=Object.keys(e),i=this;return t.forEach((function(s){let o=i.get_model_filename(e[t[s]]);if(o)switch(o.split(".").pop()){case"vsj":case"vsb":break;default:void 0===i.models_ref[e[s].id]&&i.models_count++}else void 0===i.models_ref[e[s].id]&&i.models_count++})),t.forEach((function(t){i.add_model(e[t],!0)})),this.status}calc_volume_and_area(e,t){let i,s,o,a,l,r,n,d,h,_,m,c,u,f,p=e.faces.length,g=0,y=0;for(_=0;_<p;_++)i=e.vertices[e.faces[_].a].x*t,a=e.vertices[e.faces[_].a].y*t,n=e.vertices[e.faces[_].a].z*t,s=e.vertices[e.faces[_].b].x*t,l=e.vertices[e.faces[_].b].y*t,d=e.vertices[e.faces[_].b].z*t,o=e.vertices[e.faces[_].c].x*t,r=e.vertices[e.faces[_].c].y*t,h=e.vertices[e.faces[_].c].z*t,g+=-o*l*n+s*r*n+o*a*d-i*r*d-s*a*h+i*l*h,m=e.vertices[e.faces[_].a].distanceTo(e.vertices[e.faces[_].b])*t,c=e.vertices[e.faces[_].b].distanceTo(e.vertices[e.faces[_].c])*t,u=e.vertices[e.faces[_].c].distanceTo(e.vertices[e.faces[_].a])*t,f=(m+c+u)/2,y+=Math.sqrt(f*(f-m)*(f-c)*(f-u));return[Math.abs(g/6),y,e.faces.length]}get_model_info(e){if(void 0===this.models_ref[e])return this.model_error("get_model_info - id not found: "+e);let t=this.models[this.models_ref[e]];if(!t)return null;if(!t.mesh)return null;if(!t.mesh.geometry)return null;let i=t.mesh.geometry?this.calc_volume_and_area(t.mesh.geometry,"inch"==t.units?1/25.4:1):[0,0,0];return{name:t.filename?t.filename:t.local_file?t.local_file.name:"",orig_filename:t.orig_filename?t.orig_filename:null,position:{x:t.x,y:t.y,z:t.z},dims:{x:t.mesh.geometry.maxx-t.mesh.geometry.minx,y:t.mesh.geometry.maxy-t.mesh.geometry.miny,z:t.mesh.geometry.maxz-t.mesh.geometry.minz},rotation:{x:t.mesh.rotation.x,y:t.mesh.rotation.y,z:t.mesh.rotation.z},display:t.display?t.display:null,color:t.color?t.color:null,scale:{x:t.scalex,y:t.scaley,z:t.scalez},volume:i[0],area:i[1],triangles:i[2],units:t.units,opacity:void 0!==t.opacity?t.opacity:1}}get_vsb(){let e=[],t=this;return Object.keys(this.models_ref).forEach((function(i){e.push({id:i,bin:t.get_stl_bin(i)})})),{vsj:this.get_vsj(!0,!0,!0),files:e}}get_vsj(e,t,i){this.camera.position;let s={canvas_height:this.canvas_height,bg_color:this.bg_color,camera_state:this.get_camera_state(),auto_rotate:this.auto_rotate,mouse_zoom:this.mouse_zoom,auto_resize:this.auto_resize,center_models:this.center_models};return this.grid&&(s.grid=1),s.models=[],Object.keys(this.models_ref).forEach((function(e){let o=this.models[this.models_ref[e]],a={id:i?-1:o.id};if(i)a.filename=o.id+".stl";else{let e=this.get_model_filename(o,!0,t);e&&(a.filename=e),o.local_file&&(a.local_file=o.local_file)}o.x&&(a.x=o.x),o.y&&(a.y=o.y),o.z&&(a.z=o.z),o.display&&(a.display=o.display),o.colors&&"#ffffff"==o.color||o.color&&(a.color=o.color),o.units&&(a.units=o.units),o.rotationx&&(a.rotationx=o.rotationx),o.rotationy&&(a.rotationy=o.rotationy),o.rotationz&&(a.rotationz=o.rotationz),void 0===o.scale||i||1!=o.scale&&(a.scale=o.scale),1==o.scalex||i||(a.scalex=o.scalex),1==o.scaley||i||(a.scaley=o.scaley),1==o.scalez||i||(a.scalez=o.scalez),void 0!==o.opacity&&1!=o.opacity&&(a.opacity=o.opacity),o.view_edges&&(a.view_edges=o.view_edges),o.animation&&(a.animation=JSON.parse(JSON.stringify(o.animation)),delete a.animation.start_time,delete a.animation.last_time),s.models[this.models_ref[e]]=a})),e?s:this.json_without_nulls(s)}download_vsj(e){let t=new Blob([this.get_vsj()],{type:"application/json"}),i=document.createElement("a");i.href=window.URL.createObjectURL(t);let s=e||"1",o=s.toLowerCase().indexOf(".vsj");o>=0&&(s=s.substring(0,o)),s.length<1&&(s="1"),window.navigator.msSaveOrOpenBlob?window.navigator.msSaveBlob(t,s+".vsj"):(i.download=s+".vsj",i.click(),URL.revokeObjectURL(i.href))}load_vsj(e){if(!e)return this.pre_loaded_vsj?(stl_viewer.init_by_json(this.pre_loaded_vsj),this.pre_loaded_vsj=null,!0):this.model_error("load_vsj - invalid filename"+e,this.load_error_callback);if(e instanceof File)return this.read_bin_file(e,this.init_by_json,null,!0);let t=new XMLHttpRequest,i=this;t.onreadystatechange=function(e){4==t.readyState&&200==t.status&&i.init_by_json(t.response.trim())},t.open("GET",e,!0),t.send(null)}padend(e,t,i){return t>>=0,i=String(void 0!==i?i:" "),e.length>t?String(e):((t-=e.length)>i.length&&(i+=i.repeat(t/i.length)),String(e)+i.slice(0,t))}get_normal(e,t,i){let s=t.x-e.x,o=t.y-e.y,a=t.z-e.z,l=i.x-e.x,r=i.y-e.y,n=i.z-e.z,d={x:0,y:0,z:0};d.x=o*n-a*r,d.y=a*l-s*n,d.z=s*r-o*l;let h=Math.sqrt(d.x*d.x+d.y*d.y+d.z*d.z);return 0!=h&&(d.x/=h,d.y/=h,d.z/=h),d}get_stl_bin(e){if(void 0===this.models_ref[e])return this.model_error("get_stl_bin - id not found: "+e);let t=this.models[this.models_ref[e]];if(!t)return;if(!t.mesh)return;let i=t.mesh.geometry;if(!i)return;let s=new ArrayBuffer(84+50*i.faces.length),o=new DataView(s),a=(new TextEncoder,this.padend("Binary"+(t.colors?" colored":"")+" STL by viewstl.com",80," "));for(let e=0;e<80;e++)o.setUint8(e,a.charCodeAt(e),!0);o.setUint32(80,i.faces.length,!0);let l=84;return Object.keys(i.faces).forEach((function(e){let s=i.faces[e],a=i.vertices[s.a],r=i.vertices[s.b],n=i.vertices[s.c],d=this.get_normal(a,r,n);o.setFloat32(l,d.x,!0),l+=4,o.setFloat32(l,d.y,!0),l+=4,o.setFloat32(l,d.z,!0),l+=4,o.setFloat32(l,a.x,!0),l+=4,o.setFloat32(l,a.y,!0),l+=4,o.setFloat32(l,a.z,!0),l+=4,o.setFloat32(l,r.x,!0),l+=4,o.setFloat32(l,r.y,!0),l+=4,o.setFloat32(l,r.z,!0),l+=4,o.setFloat32(l,n.x,!0),l+=4,o.setFloat32(l,n.y,!0),l+=4,o.setFloat32(l,n.z,!0),l+=4,t.colors?o.setUint16(l,Math.ceil(31*s.color.r)|Math.ceil(31*s.color.g)<<5|Math.ceil(31*s.color.b)<<10,!0):o.setUint16(l,0,!0),l+=2})),s}basename(e){return e.substr(e.lastIndexOf("/")+1)}json_without_nulls(e){return JSON.stringify(e).split(",null").join("").split("null,").join("")}read_bin_file(e,t,i,s){let o=new FileReader;o.onerror=function(e){return console.log("reading file error",e),null},o.onload=function(e){return t(e.target.result)},i&&(o.onprogress=function(e){i({loaded:e.loaded,total:e.total,load_session:-1},-1)}),s?o.readAsText(e):o.readAsArrayBuffer(e)}download_model(e,t){if(void 0===this.models_ref[e])return this.model_error("download_model - id not found: "+e);let i=this.models[this.models_ref[e]];if(!i)return;if(!i.mesh)return;let s=new Blob([this.get_stl_bin(e)],{type:"application/sla"}),o=document.createElement("a");o.href=window.URL.createObjectURL(s);let a=this.get_model_filename(i,!0,!0,!0),l=a.toLowerCase().indexOf(".stl");l>=0&&(a=a.substring(0,l)),a.length<1&&(a="1"),window.navigator.msSaveOrOpenBlob?window.navigator.msSaveBlob(s,a+".stl"):(o.download=a+".stl",o.click(),URL.revokeObjectURL(o.href))}get_model_mesh(e){if(void 0===this.models_ref[e])return this.model_error("get_model_mesh - id not found: "+e);let t=this.models[this.models_ref[e]];if(!t)return;if(!t.mesh)return;let i=t.mesh.clone();return i.geometry=t.mesh.geometry.clone(),i.material=t.mesh.material.clone(),i}set_auto_rotate(e){this.controls.autoRotate=e}set_mouse_zoom(e){this.controls.noZoom=!e}do_resize(){if(!this.parent_element)return;let e=this.parent_element.getBoundingClientRect(),t=e.width,i=e.height;this.camera.aspect=t/i,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,i)}animate(){if(this.killsign)return;Object.keys(this.animation).forEach((function(e){void 0!==this.models_ref[e]&&this.do_model_animation(this.models[this.models_ref[e]])}));let e=this;requestAnimationFrame((t=>{e.animate(t)})),this.renderer&&this.renderer.render(this.scene,this.camera),this.controls&&this.controls.update()}do_model_animation(e){if(!e.animation)return;let t=Date.now();if(e.animation.start_time||(e.animation.start_time=t),e.animation.delta){let i=(t-e.animation.start_time)/e.animation.delta.msec,s=e.animation.last_time?(t-e.animation.last_time)/e.animation.delta.msec:i;if(this.animation_next_delta(e,e.animation.delta,s),i>=1){if(!e.animation.delta.loop)return void this.remove_model_animation(e,!0);e.animation.delta.start_time=null}}if(e.animation.exact){let i=(t-(e.animation.last_time?e.animation.last_time:e.animation.start_time))/e.animation.exact.msec;if(this.animation_next_exact(e,e.animation.exact,i),t>=e.animation.start_time+e.animation.exact.msec)return void this.remove_model_animation(e,!1,!0)}e.animation.last_time=t}animation_next_delta(e,t,i){let s=!1,o=!1,a=!1;Object.keys(t).forEach((function(l){switch(l){case"x":case"y":case"z":s||(s=!0,this.set_position(e.id,e.x+(void 0!==t.x?t.x*i:0),e.y+(void 0!==t.y?t.y*i:0),e.z+(void 0!==t.z?t.z*i:0)));break;case"rotationx":case"rotationy":case"rotationz":o||(o=!0,this.rotate(e.id,void 0!==t.rotationx?t.rotationx*i:0,void 0!==t.rotationy?t.rotationy*i:0,void 0!==t.rotationz?t.rotationz*i:0));break;case"scale":case"scalex":case"scaley":case"scalez":a||(a=!0,t.scalex=t.scalex?t.scalex:t.scale?t.scale:null,t.scaley=t.scaley?t.scaley:t.scale?t.scale:null,t.scalez=t.scalez?t.scalez:t.scale?t.scale:null,this.set_scale(e.id,e.scalex+(void 0!==t.scalex?t.scalex*i:0),e.scaley+(void 0!==t.scaley?t.scaley*i:0),e.scalez+(void 0!==t.scalez?t.scalez*i:0)))}}))}animation_next_exact(e,t,i){let s=!1,o=!1,a=!1;Object.keys(t).forEach((function(l){switch(l){case"x":case"y":case"z":s||(s=!0,void 0===t.xtotal&&(t.xtotal=t.x-e.x),void 0===t.ytotal&&(t.ytotal=t.y-e.y),void 0===t.ztotal&&(t.ztotal=t.z-e.z),this.set_position(e.id,e.x+(void 0!==t.x?t.xtotal*i:0),e.y+(void 0!==t.y?t.ytotal*i:0),e.z+(void 0!==t.z?t.ztotal*i:0)));break;case"rotationx":case"rotationy":case"rotationz":if(!o){o=!0;let s=e.mesh.getWorldRotation();void 0===t.rotxtotal&&(t.rotxtotal=t.rotationx-s.x),void 0===t.rotytotal&&(t.rotytotal=t.rotationy-s.y),void 0===t.rotztotal&&(t.rotztotal=t.rotationz-s.z),this.rotate(e.id,void 0!==t.rotationx?t.rotxtotal*i:0,void 0!==t.rotationy?t.rotytotal*i:0,void 0!==t.rotationz?t.rotztotal*i:0)}break;case"scale":case"scalex":case"scaley":case"scalez":a||(a=!0,t.scalex=t.scalex?t.scalex:t.scale?t.scale:null,t.scaley=t.scaley?t.scaley:t.scale?t.scale:null,t.scalez=t.scalez?t.scalez:t.scale?t.scale:null,void 0===t.scalextotal&&(t.scalextotal=t.scalex-e.scalex),void 0===t.scaleytotal&&(t.scaleytotal=t.scaley-e.scaley),void 0===t.scaleztotal&&(t.scaleztotal=t.scalez-e.scalez),this.set_scale(e.id,e.scalex+(void 0!==t.scalex?t.scalextotal*i:0),e.scaley+(void 0!==t.scaley?t.scaleytotal*i:0),e.scalez+(void 0!==t.scalez?t.scaleztotal*i:0)))}}))}remove_model_animation(e,t,i){t&&(e.animation.delta=null),i&&(e.animation.exact=null),e.animation.delta||e.animation.exact||(e.animation=null,delete this.animation[e.id])}animate_model(e,t){if(void 0===this.models_ref[e])return this.model_error("animate-model - id not found: "+e);let i=this.models[this.models_ref[e]];if(i){if(!t)return this.remove_model_animation(i,!0,!0);i.animation=JSON.parse(JSON.stringify(t)),i.animation.delta&&(i.animation.delta.msec||(i.animation.delta.msec=300)),i.animation.exact&&(i.animation.exact.msec||(i.animation.exact.msec=300)),this.animation[e]=1}}init(){this.set_bg_color(this.bg_color),!1===this.mouse_zoom&&this.set_mouse_zoom(this.mouse_zoom),this.camera_state?this.set_camera_state(this.camera_state):this.camera.position.set(this.camerax,this.cameray,this.cameraz),this.do_resize(),this.models_to_add&&this.add_models(this.models_to_add),this.set_auto_resize(this.auto_resize),this.animate()}set_auto_resize(e){this.do_resize&&(window.removeEventListener("resize",this.do_resize),e&&window.addEventListener("resize",this.do_resize))}vf_to_geo(t,s,o,a){if(!t)return null;if(!s)return null;let l=[],r=[],n=t.length;for(i=0;i<n;i++)l.push(new e.Vector3(t[i][0],t[i][1],t[i][2]));if(n=s.length,o)for(i=0;i<n;i++){let t=new e.Face3(s[i][0],s[i][1],s[i][2]);void 0===s[i][3]?(a||(a=this.default_face_color),t.color.setRGB(parseInt(this.default_face_color.substr(1,2),16)/255,parseInt(this.default_face_color.substr(3,2),16)/255,parseInt(this.default_face_color.substr(5,2),16)/255)):t.color.setRGB(s[i][3],s[i][4],s[i][5]),r.push(t)}else for(i=0;i<n;i++)r.push(new e.Face3(s[i][0],s[i][1],s[i][2]));let d=new e.Geometry;return d.vertices=l,d.faces=r,d.computeBoundingBox(),d.computeFaceNormals(),d.computeVertexNormals(),this.center_models&&d.center(d),d}set_geo_minmax(e){let t=e.mesh.geometry;if(t.boundingBox)t.minx=t.boundingBox.min.x,t.miny=t.boundingBox.min.y,t.minz=t.boundingBox.min.z,t.maxx=t.boundingBox.max.x,t.maxy=t.boundingBox.max.y,t.maxz=t.boundingBox.max.z;else{let i=t.vertices,s=i[0].x,o=i[0].y,a=i[0].z,l=i[0].x,r=i[0].y,n=i[0].z,d=i.length;for(;d--;)i[d].x<s&&(s=i[d].x),i[d].y<o&&(o=i[d].y),i[d].z<a&&(a=i[d].z),i[d].x>l&&(l=i[d].x),i[d].y>r&&(r=i[d].y),i[d].z>n&&(n=i[d].z);t.minx=s+e.x,t.miny=o+e.y,t.minz=a+e.z,t.maxx=l+e.x,t.maxy=r+e.y,t.maxz=n+e.z}}handleDragOver(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}handleFileDrop(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.files.length>0?this.load_local_files(e.dataTransfer.files):"string"==typeof e.dataTransfer.getData("Text")&&(this.add_model({id:-1,filename:e.dataTransfer.getData("Text")}),this.on_model_drop&&this.on_model_drop(e.dataTransfer.getData("Text")))}load_local_files(e){if(e.length>0){let t=new Array,i=e.length;for(let s=0;s<i;s++){switch(e[s].name.split(".").pop()){case"vsj":this.load_vsj(e[s]);break;case"vsb":this.load_vsb(e[s]);break;default:t.push({id:-1,local_file:e[s]})}this.on_model_drop&&this.on_model_drop(e[s].name)}this.add_models(t)}}clean(){if(this.models=null,this.models=[],this.models_count=0,this.models_ref=null,this.models_ref=[],this.max_model_id=0,this.load_status=null,this.load_status=[],this.load_session=0,this.loaded_models_arr=null,this.loaded_models_arr=[],this.animation=null,this.animation=[],this.models_to_add=null,this.models_to_add=[],this.options.models=null,!this.scene)return;let e=this.scene;for(i=e.children.length;i--;)"Mesh"===e.children[i].type&&(e.children[i].geometry.dispose(),e.children[i].material.dispose(),e.remove(e.children[i]));Object.keys(this.models_ref).forEach((function(e){this.set_or_update_geo_edges(this.models[this.models_ref[e]],!1)})),this.renderer.renderLists.dispose()}reset_parent_element(e){this.parent_element=e,this.allow_drag_and_drop&&this.set_drag_and_drop(!0),this.set_on_model_mousedown(this.onmousedown_callback),this.parent_element.appendChild(this.renderer.domElement)}external_files_loaded(){this.ready=!0,this.init(),this.ready_callback&&this.ready_callback()}init_by_json(e){let t=null;try{t=JSON.parse(e)}catch(t){return console.log("json error ",e),!1}this.options=t,this.set_options(),this.ready&&this.init()}dispose(){this.clean(),this.killsign=!0,this.renderer&&this.renderer.render(this.scene,this.camera),this.controls&&this.controls.update(),this.animate=null,this.animation=null,this.error=null,this.options=null,this.parent_element=null,this.models_to_add=null,this.models=null,this.models_ref=null,this.model_loaded_callback=null,this.all_loaded_callback=null,this.load_error_callback=null,this.loading_progress_callback=null,this.load_status=null,this.loaded_models_arr=null,this.onmousedown_callback=null,this.camera_state=null,this.ready_callback=null,this.on_model_drop=null,this.pre_loaded_ab_files=null,this.pre_loaded_vsj=null,this.grid=null,this.WORLD_X_VECTOR=null,this.WORLD_Y_VECTOR=null,this.WORLD_Z_VECTOR=null,this.edges_material=null,this.raycaster=null,this.mouse=null,this.renderer=null,this.scene=null,this.camera=null,this.ambientLight=null,this.directionalLight=null,this.pointLight=null,this.controls=null}constructor(t,i){if(this.error=null,this.options=i,this.parent_element=t,this.canvas_width="100%",this.canvas_height="100%",this.bg_color="transparent",this.models_to_add=[],this.models=new Array,this.models_count=0,this.models_ref=new Array,this.allow_drag_and_drop=this.get_opt("allow_drag_and_drop",!0),this.model_loaded_callback=null,this.all_loaded_callback=null,this.load_error_callback=null,this.loading_progress_callback=null,this.max_model_id=0,this.load_status=new Array,this.load_session=0,this.loaded_models_arr=new Array,this.status=0,this.onmousedown_callback=null,this.zoom=-1,this.camerax=0,this.cameray=0,this.cameraz=0,this.camera_state=null,this.auto_rotate=!1,this.mouse_zoom=!0,this.ready=void 0!==e,this.ready_callback=null,this.jszip_path=null,this.jszip_utils_path=null,this.auto_resize=!0,this.on_model_drop=null,this.center_models=!0,this.controls_type=0,this.zoom=-1,this.pre_loaded_ab_files=null,this.pre_loaded_vsj=null,this.zip_load_count=-1,this.send_no_model_click_event=!1,this.grid=null,this.killsign=!1,this.default_face_color="#909090",this.is_ie=!!window.MSStream,this.MSG2WORKER_DATA=0,this.MSG2WORKER_LOAD=1,this.MSG2WORKER_ERROR=2,this.MSGFROMWORKER_STL_LOADED=3,this.MSGFROMWORKER_LOAD_IN_PROGRESS=4,this.WORLD_X_VECTOR=null,this.WORLD_Y_VECTOR=null,this.WORLD_Z_VECTOR=null,this.maxx=null,this.maxy=null,this.maxz=null,this.minx=null,this.miny=null,this.minz=null,this.edges_material=null,this.raycaster=null,this.mouse=null,this.scene=null,this.renderer=null,this.camera=null,this.ambientLight=null,this.directionalLight=null,this.pointLight=null,this.controls=null,this.animation=new Array,this.set_options(),this.ready){if(this.set_on_model_mousedown(this.onmousedown_callback),this.WORLD_X_VECTOR=new e.Vector3(1,0,0),this.WORLD_Y_VECTOR=new e.Vector3(0,1,0),this.WORLD_Z_VECTOR=new e.Vector3(0,0,1),this.edges_material=new e.LineBasicMaterial({color:0}),this.raycaster=new e.Raycaster,this.mouse=new e.Vector2,this.scene=new e.Scene,this.renderer=new e.WebGLRenderer({preserveDrawingBuffer:!0,alpha:!0}),this.camera=new e.PerspectiveCamera(45,1,.1,1e5),this.parent_element.appendChild(this.renderer.domElement),this.scene.add(this.camera),this.ambientLight=new e.AmbientLight(2105376),this.camera.add(this.ambientLight),this.directionalLight=new e.DirectionalLight(16777215,.75),this.directionalLight.position.x=1,this.directionalLight.position.y=1,this.directionalLight.position.z=2,this.directionalLight.position.normalize(),this.camera.add(this.directionalLight),this.pointLight=new e.PointLight(16777215,.3),this.pointLight.position.x=0,this.pointLight.position.y=-25,this.pointLight.position.z=10,this.camera.add(this.pointLight),1===this.controls_type)this.controls=new e.TrackballControls(this.camera,this.renderer.domElement);else this.controls=new e.OrbitControls(this.camera,this.renderer.domElement),this.controls.autoRotate=this.auto_rotate;this.init(),this.ready_callback&&this.ready_callback()}}}l.StlViewer=n,l.THREE=e;
//# sourceMappingURL=StlViewer.js.map
